#!/bin/bash
# torc-deploy - Deploy a multi-agent team for a project (B Architecture: Dynamic Creation)
# Usage: torc deploy <project-path> [--spec <file>]
#
# B Architecture:
# 1. Only Orchestrator is created initially
# 2. Orchestrator dynamically creates PL
# 3. PL requests executors from Orchestrator
# 4. Orchestrator creates executors as needed

set -euo pipefail
TORC_BIN="$(cd "$(dirname "$0")" && pwd)"
source "$TORC_BIN/../lib/config.sh"
source "$TORC_BIN/../lib/state.sh"
source "$TORC_BIN/../lib/tmux.sh"
source "$TORC_BIN/../lib/worktree.sh"

usage() {
    cat <<'EOF'
Usage: torc deploy <project-path> [options]

Options:
  --spec <file>      Spec/requirements file to brief agents with

Examples:
  torc deploy ~/projects/my-app
  torc deploy ~/projects/my-app --spec ~/specs/feature.md
EOF
}

# Parse arguments
SPEC_FILE=""
PROJECT_PATH=""

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help) usage; exit 0 ;;
        --spec) SPEC_FILE="$2"; shift 2 ;;
        -*) echo "Unknown option: $1" >&2; exit 1 ;;
        *) PROJECT_PATH="$1"; shift ;;
    esac
done

if [ -z "$PROJECT_PATH" ]; then
    echo "Error: project path required" >&2
    usage
    exit 1
fi

# Resolve to absolute path
PROJECT_PATH="$(cd "$PROJECT_PATH" && pwd)"
PROJECT_NAME="$(basename "$PROJECT_PATH")"
SESSION="torc-$PROJECT_NAME"
TEAM_NAME="$PROJECT_NAME"

# Validate it's a git repo
if ! git -C "$PROJECT_PATH" rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: $PROJECT_PATH is not a git repository" >&2
    exit 1
fi

# Check if team already exists
if team_exists "$TEAM_NAME"; then
    echo "Error: team '$TEAM_NAME' already exists. Use 'torc teardown $TEAM_NAME' first." >&2
    exit 1
fi

# Check if tmux session already exists
if tmux_session_exists "$SESSION"; then
    echo "Error: tmux session '$SESSION' already exists." >&2
    exit 1
fi

# Check if running inside tmux and warn
if [ -n "${TMUX:-}" ]; then
    CURRENT_SESSION=$(tmux display-message -p '#{session_name}' 2>/dev/null || echo "unknown")
    echo "⚠️  Warning: You are currently inside tmux session '$CURRENT_SESSION'"
    echo "    Tmux Orchestrator will create a new session '$SESSION'"
    echo "    Your current session will not be affected."
    echo ""
fi

echo "Deploying team '$TEAM_NAME' for $PROJECT_PATH"
echo "  Session: $SESSION"
echo "  Architecture: B (Dynamic Creation - Orchestrator bootstraps team)"
[ -n "$SPEC_FILE" ] && echo "  Spec: $SPEC_FILE"
echo ""

# Resolve spec file path
[ -n "$SPEC_FILE" ] && SPEC_FILE="$(cd "$(dirname "$SPEC_FILE")" && pwd)/$(basename "$SPEC_FILE")"

# B ARCHITECTURE with HIERARCHICAL WORKTREES:
# 1. Orchestrator created in main project
# 2. PL worktree created from main, PL works there
# 3. Executor worktrees created from PL's worktree
# Hierarchy: main -> PL-worktree -> Executor-worktrees

echo "Creating tmux session with Orchestrator..."
tmux_create_session "$SESSION" "$PROJECT_PATH" "Orchestrator"
sleep 0.5

# Create PL worktree from main
echo "Creating PL worktree..."
PL_WORKTREE=$(worktree_create "$PROJECT_PATH" "pl")
echo "  PL worktree: $PL_WORKTREE"

# Get CLI for orchestrator
ORCH_CLI=$(get_cli_command "orchestrator" "$PROJECT_PATH")

# Write initial team state (only orchestrator)
CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
STATE_JSON=$(python3 -c "
import json
state = {
    'team_name': '$TEAM_NAME',
    'project_path': '$PROJECT_PATH',
    'session': '$SESSION',
    'created_at': '$CREATED_AT',
    'spec_file': '$SPEC_FILE',
    'agents': {
        'orchestrator': {
            'window': 'Orchestrator',
            'cli': '$ORCH_CLI',
            'role': 'orchestrator'
        }
    },
    'dynamic_creation': True,
    'executors_needed': 0,
    'executors_created': []
}
print(json.dumps(state, indent=2))
")
write_team_state "$TEAM_NAME" "$STATE_JSON"

# Start Orchestrator agent
echo ""
echo "Starting Orchestrator agent..."
"$TORC_BIN/torc-start-agent" "$SESSION:Orchestrator" orchestrator "$PROJECT_PATH"
sleep 2

# Send comprehensive briefing to Orchestrator
echo "Sending briefing to Orchestrator..."

USER_PLAN="${SPEC_FILE_CONTENT:-'Create a project showcase site. Plan and execute autonomously.'}"

ORCH_BRIEFING="=== USER'S PLAN ===
$USER_PLAN

=== YOUR MISSION ===
Execute the above plan. Create team, monitor progress, ensure completion.

=== PHASE 1: BOOTSTRAP (DO NOW) ===
Step 1: Create PL worktree from main, then PL window
git -C $PROJECT_PATH worktree add .worktrees/pl -b pl-\$(date +%Y%m%d)
tmux new-window -t $SESSION -n 'PL' -c '$PROJECT_PATH/.worktrees/pl'

Step 2: Start PL agent
torc start-agent \$SESSION:PL project_leader $PROJECT_PATH

Step 3: Send plan to PL (include the user's plan above)
torc send \$SESSION:PL 'Execute this plan: $USER_PLAN. Plan the work, break into tasks, tell me how many executors you need. Start immediately.'

=== PHASE 2: CREATE EXECUTORS (When PL responds with N) ===
For i in 1..N:
  git -C $PROJECT_PATH worktree add .worktrees/executor-\$i -b executor-\$i-\$(date +%Y%m%d) .worktrees/pl
  tmux new-window -t \$SESSION -n "Exec-\$i" -c "$PROJECT_PATH/.worktrees/executor-\$i"
  torc start-agent \$SESSION:Exec-\$i executor $PROJECT_PATH

=== PHASE 3: MONITOR UNTIL COMPLETE ===
while true; do
  # Check main branch
  git -C $PROJECT_PATH status --short; git -C $PROJECT_PATH log --oneline -3

  # Check PL worktree
  git -C $PROJECT_PATH/.worktrees/pl status --short
  git -C $PROJECT_PATH/.worktrees/pl log --oneline -5

  # Check all executor worktrees
  for exec in executor-1 executor-2 executor-3; do
    if [ -d \"$PROJECT_PATH/.worktrees/\$exec\" ]; then
      git -C $PROJECT_PATH/.worktrees/\$exec log --oneline | wc -l
    fi
  done

  # Ask PL: which executors done?
  torc send \$SESSION:PL 'Status: Which executors have completed?'

  # If PL says ALL done → Phase 4
  sleep 300
done

=== PHASE 4: MERGE ===
Step 8: PL merges executor branches to their worktree
git -C $PROJECT_PATH/.worktrees/pl merge executor-N-YYYYMMDD

Step 9: PL merges to main
git -C $PROJECT_PATH checkout main
git -C $PROJECT_PATH merge pl-YYYYMMDD

Step 10: Report to user
'All tasks complete. Work merged to main.'

=== COMPLETION RULES ===
Task NOT complete until:
- [ ] All executors committed files
- [ ] All executor branches merged to PL worktree
- [ ] PL worktree merged to main
- [ ] You verified main has all changes

DO NOT STOP until ALL checked!

=== START NOW ===
Execute Phase 1 immediately. Do not wait."

# Send briefing line by line to avoid issues
echo "$ORCH_BRIEFING" | while IFS= read -r line; do
    tmux_send "$SESSION:Orchestrator" "$line"
    sleep 0.1
done

echo ""
echo "=== Orchestrator Deployed ==="
echo "Session: $SESSION"
echo "Windows:"
tmux_list_windows "$SESSION"
echo ""
echo "State: $(team_state_file "$TEAM_NAME")"
echo ""
echo "Orchestrator is now bootstrapping the team..."
echo "Next steps:"
echo "  1. Orchestrator creates PL"
echo "  2. PL plans and requests executors"
echo "  3. Orchestrator creates executors"
echo ""
echo "Monitor progress:"
echo "  torc status $TEAM_NAME"
echo "  torc send $SESSION:Orchestrator 'Status?'"
echo "  tmux attach -t $SESSION"
