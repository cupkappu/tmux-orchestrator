#!/bin/bash
# torc-deploy - Deploy a multi-agent team for a project (B Architecture: Dynamic Creation)
# Usage: torc deploy <project-path> [--spec <file>]
#
# B Architecture:
# 1. Only Orchestrator is created initially
# 2. Orchestrator dynamically creates PL
# 3. PL requests executors from Orchestrator
# 4. Orchestrator creates executors as needed

set -euo pipefail
TORC_BIN="$(cd "$(dirname "$0")" && pwd)"
source "$TORC_BIN/../lib/config.sh"
source "$TORC_BIN/../lib/state.sh"
source "$TORC_BIN/../lib/tmux.sh"
source "$TORC_BIN/../lib/worktree.sh"

usage() {
    cat <<'EOF'
Usage: torc deploy <project-path> [options]

Options:
  --spec <file>      Spec/requirements file to brief agents with

Examples:
  torc deploy ~/projects/my-app
  torc deploy ~/projects/my-app --spec ~/specs/feature.md
EOF
}

# Parse arguments
SPEC_FILE=""
PROJECT_PATH=""

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help) usage; exit 0 ;;
        --spec) SPEC_FILE="$2"; shift 2 ;;
        -*) echo "Unknown option: $1" >&2; exit 1 ;;
        *) PROJECT_PATH="$1"; shift ;;
    esac
done

if [ -z "$PROJECT_PATH" ]; then
    echo "Error: project path required" >&2
    usage
    exit 1
fi

# Resolve to absolute path
PROJECT_PATH="$(cd "$PROJECT_PATH" && pwd)"
PROJECT_NAME="$(basename "$PROJECT_PATH")"
SESSION="torc-$PROJECT_NAME"
TEAM_NAME="$PROJECT_NAME"

# Validate it's a git repo
if ! git -C "$PROJECT_PATH" rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: $PROJECT_PATH is not a git repository" >&2
    exit 1
fi

# Check if team already exists
if team_exists "$TEAM_NAME"; then
    echo "Error: team '$TEAM_NAME' already exists. Use 'torc teardown $TEAM_NAME' first." >&2
    exit 1
fi

# Check if tmux session already exists
if tmux_session_exists "$SESSION"; then
    echo "Error: tmux session '$SESSION' already exists." >&2
    exit 1
fi

# Check if running inside tmux and warn
if [ -n "${TMUX:-}" ]; then
    CURRENT_SESSION=$(tmux display-message -p '#{session_name}' 2>/dev/null || echo "unknown")
    echo "⚠️  Warning: You are currently inside tmux session '$CURRENT_SESSION'"
    echo "    Tmux Orchestrator will create a new session '$SESSION'"
    echo "    Your current session will not be affected."
    echo ""
fi

echo "Deploying team '$TEAM_NAME' for $PROJECT_PATH"
echo "  Session: $SESSION"
echo "  Architecture: B (Dynamic Creation - Orchestrator bootstraps team)"
[ -n "$SPEC_FILE" ] && echo "  Spec: $SPEC_FILE"
echo ""

# Resolve spec file path
[ -n "$SPEC_FILE" ] && SPEC_FILE="$(cd "$(dirname "$SPEC_FILE")" && pwd)/$(basename "$SPEC_FILE")"

# B ARCHITECTURE: Only create Orchestrator initially
# Orchestrator will dynamically create PL and Executors

echo "Creating tmux session with Orchestrator..."
tmux_create_session "$SESSION" "$PROJECT_PATH" "Orchestrator"
sleep 0.5

# Get CLI for orchestrator
ORCH_CLI=$(get_cli_command "orchestrator" "$PROJECT_PATH")

# Write initial team state (only orchestrator)
CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
STATE_JSON=$(python3 -c "
import json
state = {
    'team_name': '$TEAM_NAME',
    'project_path': '$PROJECT_PATH',
    'session': '$SESSION',
    'created_at': '$CREATED_AT',
    'spec_file': '$SPEC_FILE',
    'agents': {
        'orchestrator': {
            'window': 'Orchestrator',
            'cli': '$ORCH_CLI',
            'role': 'orchestrator'
        }
    },
    'dynamic_creation': True,
    'executors_needed': 0,
    'executors_created': []
}
print(json.dumps(state, indent=2))
")
write_team_state "$TEAM_NAME" "$STATE_JSON"

# Start Orchestrator agent
echo ""
echo "Starting Orchestrator agent..."
"$TORC_BIN/torc-start-agent" "$SESSION:Orchestrator" orchestrator "$PROJECT_PATH"
sleep 2

# Send comprehensive briefing to Orchestrator
echo "Sending briefing to Orchestrator..."

ORCH_BRIEFING="You are the AI Orchestrator for the '$PROJECT_NAME' project.

=== YOUR ROLE ===
You are the COMMANDER. You dynamically create and manage the entire team.

=== B ARCHITECTURE DYNAMIC CREATION ===
Phase 1: Bootstrap (YOU DO THIS NOW)
1. Create PL window: tmux new-window -t $SESSION -n 'PL' -c '$PROJECT_PATH'
2. Start PL agent: torc start-agent $SESSION:PL project_leader $PROJECT_PATH
3. Brief PL on the project
4. Ask PL: 'What is the plan? How many executors do you need?'

Phase 2: Team Building (AFTER PL RESPONDS)
When PL tells you they need N executors:
1. Create worktrees: torc worktree create $PROJECT_PATH executor-1, executor-2, etc.
2. Create windows: tmux new-window -t $SESSION -n 'Exec-N' -c 'worktree-path'
3. Start executor agents: torc start-agent $SESSION:Exec-N executor $PROJECT_PATH
4. Brief each executor with their specific task
5. Update team state file

Phase 3: Monitoring
- Check status: torc status $TEAM_NAME
- Coordinate via PL (not directly with executors)
- Scale up if PL requests more executors

=== PROJECT INFO ===
Project: $PROJECT_NAME
Path: $PROJECT_PATH
Session: $SESSION
Spec file: ${SPEC_FILE:-'(none provided)'}

=== AVAILABLE COMMANDS ===
tmux new-window -t $SESSION -n 'WindowName' -c '$PROJECT_PATH'
torc start-agent $SESSION:WindowName role
torc worktree create $PROJECT_PATH executor-id
torc status $TEAM_NAME
torc send $SESSION:WindowName 'message'
tmux list-windows -t $SESSION

=== START NOW ===
1. Create the PL window and start PL agent
2. Brief PL on this project
3. Ask for their plan and executor requirements"

# Send briefing line by line to avoid issues
echo "$ORCH_BRIEFING" | while IFS= read -r line; do
    tmux_send "$SESSION:Orchestrator" "$line"
    sleep 0.1
done

echo ""
echo "=== Orchestrator Deployed ==="
echo "Session: $SESSION"
echo "Windows:"
tmux_list_windows "$SESSION"
echo ""
echo "State: $(team_state_file "$TEAM_NAME")"
echo ""
echo "Orchestrator is now bootstrapping the team..."
echo "Next steps:"
echo "  1. Orchestrator creates PL"
echo "  2. PL plans and requests executors"
echo "  3. Orchestrator creates executors"
echo ""
echo "Monitor progress:"
echo "  torc status $TEAM_NAME"
echo "  torc send $SESSION:Orchestrator 'Status?'"
echo "  tmux attach -t $SESSION"
