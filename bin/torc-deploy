#!/bin/bash
# torc-deploy - Deploy a multi-agent team for a project (B Architecture: Dynamic Creation)
# Usage: torc deploy <project-path> [--spec <file>]
#
# B Architecture:
# 1. Only Orchestrator is created initially
# 2. Orchestrator dynamically creates PL
# 3. PL requests executors from Orchestrator
# 4. Orchestrator creates executors as needed

set -euo pipefail
TORC_BIN="$(cd "$(dirname "$0")" && pwd)"
source "$TORC_BIN/../lib/config.sh"
source "$TORC_BIN/../lib/state.sh"
source "$TORC_BIN/../lib/tmux.sh"
source "$TORC_BIN/../lib/worktree.sh"

usage() {
    cat <<'EOF'
Usage: torc deploy <project-path> [options]

Options:
  --spec <file>      Spec/requirements file to brief agents with

Examples:
  torc deploy ~/projects/my-app
  torc deploy ~/projects/my-app --spec ~/specs/feature.md
EOF
}

# Parse arguments
SPEC_FILE=""
PROJECT_PATH=""

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help) usage; exit 0 ;;
        --spec) SPEC_FILE="$2"; shift 2 ;;
        -*) echo "Unknown option: $1" >&2; exit 1 ;;
        *) PROJECT_PATH="$1"; shift ;;
    esac
done

if [ -z "$PROJECT_PATH" ]; then
    echo "Error: project path required" >&2
    usage
    exit 1
fi

# Resolve to absolute path
PROJECT_PATH="$(cd "$PROJECT_PATH" && pwd)"
PROJECT_NAME="$(basename "$PROJECT_PATH")"
SESSION="torc-$PROJECT_NAME"
TEAM_NAME="$PROJECT_NAME"

# Validate it's a git repo
if ! git -C "$PROJECT_PATH" rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: $PROJECT_PATH is not a git repository" >&2
    exit 1
fi

# Check if team already exists
if team_exists "$TEAM_NAME"; then
    echo "Error: team '$TEAM_NAME' already exists. Use 'torc teardown $TEAM_NAME' first." >&2
    exit 1
fi

# Check if tmux session already exists
if tmux_session_exists "$SESSION"; then
    echo "Error: tmux session '$SESSION' already exists." >&2
    exit 1
fi

# Check if running inside tmux and warn
if [ -n "${TMUX:-}" ]; then
    CURRENT_SESSION=$(tmux display-message -p '#{session_name}' 2>/dev/null || echo "unknown")
    echo "⚠️  Warning: You are currently inside tmux session '$CURRENT_SESSION'"
    echo "    Tmux Orchestrator will create a new session '$SESSION'"
    echo "    Your current session will not be affected."
    echo ""
fi

echo "Deploying team '$TEAM_NAME' for $PROJECT_PATH"
echo "  Session: $SESSION"
echo "  Architecture: B (Dynamic Creation - Orchestrator bootstraps team)"
[ -n "$SPEC_FILE" ] && echo "  Spec: $SPEC_FILE"
echo ""

# Resolve spec file path
[ -n "$SPEC_FILE" ] && SPEC_FILE="$(cd "$(dirname "$SPEC_FILE")" && pwd)/$(basename "$SPEC_FILE")"

# B ARCHITECTURE with HIERARCHICAL WORKTREES:
# 1. Orchestrator created in main project
# 2. PL worktree created from main by Orchestrator
# 3. Executor worktrees created from PL's worktree by Orchestrator
# Hierarchy: main -> Orchestrator -> PL -> Executors

echo "Creating tmux session with Orchestrator..."
tmux_create_session "$SESSION" "$PROJECT_PATH" "Orchestrator"
sleep 0.5

# Get CLI for orchestrator
ORCH_CLI=$(get_cli_command "orchestrator" "$PROJECT_PATH")

# Write initial team state (only orchestrator)
CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
STATE_JSON=$(python3 -c "
import json
state = {
    'team_name': '$TEAM_NAME',
    'project_path': '$PROJECT_PATH',
    'session': '$SESSION',
    'created_at': '$CREATED_AT',
    'spec_file': '$SPEC_FILE',
    'agents': {
        'orchestrator': {
            'window': 'Orchestrator',
            'cli': '$ORCH_CLI',
            'role': 'orchestrator'
        }
    },
    'dynamic_creation': True,
    'pls_created': [],
    'executors_needed': 0,
    'executors_created': []
}
print(json.dumps(state, indent=2))
")
write_team_state "$TEAM_NAME" "$STATE_JSON"

# Start Orchestrator agent
echo ""
echo "Starting Orchestrator agent..."
"$TORC_BIN/torc-start-agent" "$SESSION:Orchestrator" orchestrator "$PROJECT_PATH"
sleep 2

# Send comprehensive briefing to Orchestrator
echo "Sending briefing to Orchestrator..."

# Read spec content if file exists
USER_PLAN="Create a project showcase site. Plan and execute autonomously."
if [ -n "$SPEC_FILE" ] && [ -f "$SPEC_FILE" ]; then
    USER_PLAN=$(cat "$SPEC_FILE")
fi

# Export TORC_BIN for templates to use
export TORC_BIN

ORCH_BRIEFING="=== ENVIRONMENT ===
TORC_BIN: $TORC_BIN (Use this full path for ALL torc commands)
SESSION: $SESSION
PROJECT_PATH: $PROJECT_PATH

=== USER'S PLAN ===
$USER_PLAN

=== YOUR MISSION ===
You are Orchestrator. Create PL, let PL decide executor count, create executors, monitor until complete.

=== PHASE 1: CREATE PL (DO NOW) ===
Create ONE PL worktree and window, start PL agent:

git -C $PROJECT_PATH worktree add .worktrees/PL -b pl-\$(date +%Y%m%d)
tmux new-window -t $SESSION -n 'PL' -c '$PROJECT_PATH/.worktrees/PL'
$TORC_BIN/torc-start-agent $SESSION:PL project_leader $PROJECT_PATH
sleep 2
$TORC_BIN/torc-send $SESSION:PL \"You are Project Leader. Mission: build multi-user todo app with auth, real-time collaboration, nice UI. 

CRITICAL: Follow this exact sequence:
1. Analyze the spec and decide executor count (2-4 recommended)
2. REPORT to Orchestrator FIRST using: $TORC_BIN/torc-send $SESSION:Orchestrator 'Need N executors: [list what each does]'
3. STOP and WAIT for Orchestrator to create executors
4. ONLY AFTER executors are created, assign tasks to them
5. After assigning tasks, START OVERSIGHT LOOP using: /torc-pm-oversight $SESSION

DO NOT write code or create files before reporting executor count to Orchestrator.\"

=== PHASE 2: CREATE EXECUTORS (When PL reports N) ===
PL will message you: 'Need N executors...'
For each executor i from 1 to N:
  git -C $PROJECT_PATH worktree add .worktrees/Exec-\$i -b exec-\$i-\$(date +%Y%m%d) .worktrees/PL
  tmux new-window -t $SESSION -n \"Exec-\$i\" -c \"$PROJECT_PATH/.worktrees/Exec-\$i\"
  $TORC_BIN/torc-start-agent $SESSION:Exec-\$i executor $PROJECT_PATH
After creating all, notify PL: $TORC_BIN/torc-send $SESSION:PL 'Executors 1-N ready. IMPORTANT: After assigning tasks, START OVERSIGHT LOOP to monitor progress: /torc-pm-oversight $SESSION'

=== PHASE 3: MONITOR PL ONLY (NOT executors) ===
DO NOT monitor executors - PL monitors them via /torc-pm-oversight.
- After PL starts oversight loop, wait 5 minutes then check PL
- Check PL status: git -C $PROJECT_PATH/.worktrees/PL log --oneline
- Check every 5 minutes: sleep 300 && git -C $PROJECT_PATH/.worktrees/PL log --oneline
- Only intervene if PL is stuck/unresponsive for 10+ minutes

=== PHASE 4: FINAL MERGE (When PL reports done) ===
PL will say: 'All executors merged to my branch'
Then merge PL to main:
git -C $PROJECT_PATH checkout main
git -C $PROJECT_PATH merge pl-\$(date +%Y%m%d)
Report to user: 'All work merged to main. Complete.'

=== WINDOW NAMING CONVENTION ===
- PL window: 'PL'
- Executor windows: 'Exec-1', 'Exec-2', etc.
Use EXACT names for torc-send commands.

=== START NOW ===
Execute Phase 1. Create PL immediately."

# Send briefing as single message (not line-by-line to save tokens)
tmux_send "$SESSION:Orchestrator" "$ORCH_BRIEFING"

echo ""
echo "=== Orchestrator Deployed ==="
echo "Session: $SESSION"
echo "Windows:"
tmux_list_windows "$SESSION"
echo ""
echo "State: $(team_state_file "$TEAM_NAME")"
echo ""
echo "Orchestrator is now bootstrapping the team..."
echo "Next steps:"
echo "  1. Orchestrator creates PL"
echo "  2. PL plans and requests executors"
echo "  3. Orchestrator creates executors"
echo ""
echo "Monitor progress:"
echo "  torc status $TEAM_NAME"
echo "  torc send $SESSION:Orchestrator 'Status?'"
echo "  tmux attach -t $SESSION"
