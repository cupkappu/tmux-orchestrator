#!/bin/bash
# torc-team - Unified entry point for team commands
# Usage: torc team <command> [args]
#
# Commands:
#   init        Create a team with task list
#   spawn       Spawn N agents for a team
#   claim       Agent: claim next available task
#   plan-submit Agent: submit plan for approval
#   approve     Lead: approve submitted plan
#   reject      Lead: reject plan with feedback
#   done        Agent: mark task complete
#   status      Show team/task/agent status
#   broadcast   Message all agents

set -euo pipefail
TORC_BIN="$(cd "$(dirname "$0")" && pwd)"

usage() {
    cat <<'EOF'
Usage: torc team <command> [args]

Team Management:
  init <project> [--name <name>]     Create team with empty task list
  deploy <project> --spec <file>    Deploy self-organizing team (Lead+agents)
  spawn-lead <team> [--cli <tool>]   Spawn Lead for team
  spawn <team> <n> [--cli <tool>]   Spawn N agents
  resume <team> [options]           Resume team (recreate session)
    --spawn-lead                    Respawn Lead
    --spawn-agents <n>              Respawn N agents
  shutdown <team>                   Graceful shutdown when all tasks done
  status <team> [--task <id>]       Show status
  health <team>                     Show health metrics & blockers
  inbox <team> <agent>              Read & clear agent inbox
  monitor <team> [--tail <n>]       Live event-stream window

Agent Actions:
  claim <team> <agent>              Claim next available task
  plan-submit <team> <task> <plan>  Submit plan for approval
  done <team> <task> [<result>]     Mark task complete
  propose <team> <agent> <title> <desc>  Propose new task

Lead Actions:
  approve <team> <task>             Approve submitted plan
  reject <team> <task> <feedback>   Reject plan with feedback
  proposals <team>                  List pending proposals
  approve-proposal <team> <id>      Approve task proposal
  reject-proposal <team> <id> [reason]  Reject task proposal

Communication:
  broadcast <team> <msg>            Message all agents
  msg <team> <from> <to> <msg>      Send direct message

Examples:
  torc team init ~/my-app            # create team with empty task list
  torc team spawn-lead my-app        # spawn Lead
  torc team spawn my-app 3           # spawn 3 agents
  torc team proposals my-app         # review pending proposals
  torc team status my-app

  # Session crashed? Resume with all agents:
  torc team resume my-app --spawn-lead --spawn-agents 3
EOF
}

if [ $# -lt 1 ]; then
    usage
    exit 1
fi

COMMAND="${1:-}"
shift

case "$COMMAND" in
    init|deploy|spawn|spawn-lead|resume|shutdown|claim|plan-submit|approve|reject|done|status|health|broadcast|inbox|monitor|proposals|approve-proposal|reject-proposal|propose|msg)
        if [ -x "$TORC_BIN/torc-team-$COMMAND" ]; then
            "$TORC_BIN/torc-team-$COMMAND" "$@"
        else
            echo "Error: command '$COMMAND' not implemented" >&2
            exit 1
        fi
        ;;
    -h|--help|help)
        usage
        exit 0
        ;;
    *)
        echo "Unknown command: $COMMAND" >&2
        usage
        exit 1
        ;;
esac
