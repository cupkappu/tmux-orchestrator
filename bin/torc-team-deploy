#!/bin/bash
# torc-team-deploy - Deploy a self-organizing team with Lead coordinator
# Usage: torc team deploy <project-path> [--spec <file>] [--teammates <n>]
#
# Flow:
#   1. Spawn Lead only
#   2. Lead reads spec, generates task list (as T-000)
#   3. Lead spawns teammates
#   4. Teammates self-claim and work

set -euo pipefail
TORC_BIN="$(cd "$(dirname "$0")" && pwd)"
source "$TORC_BIN/../lib/config.sh"
source "$TORC_BIN/../lib/state.sh"
source "$TORC_BIN/../lib/tasks.sh"
source "$TORC_BIN/../lib/worktree.sh"
source "$TORC_BIN/../lib/tmux.sh"

usage() {
    cat <<'EOF'
Usage: torc team deploy <project-path> [options]

Deploy a self-organizing team. Only spawns Lead initially.
Lead reads charter, generates tasks, then spawns teammates.

Options:
  --charter <file>     Project charter (copied to project/CHARTER.md)
  --spec <file>        Alias for --charter (deprecated)
  --teammates <n>      Max teammates to spawn (default: 3)
  --name <team-name>   Override team name
  --lead-cli <tool>    Lead CLI: claude/kimi/opencode (default: claude)
  --teammate-cli <tool> Teammate CLI: kimi/opencode/claude (default: kimi)

Examples:
  torc team deploy ~/projects/my-app --charter requirements.md
  torc team deploy ~/projects/my-app --teammates 2 --lead-cli kimi
EOF
}

# ── Parse args ─────────────────────────────────────────────────────────────────

PROJECT_PATH=""
CHARTER_FILE=""
TEAMMATE_COUNT=3
TEAM_NAME_OVERRIDE=""
LEAD_CLI_NAME=$(get_selforg_default_cli "lead")
TEAMMATE_CLI_NAME=$(get_selforg_default_cli "agent")

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)          usage; exit 0 ;;
        --charter)          CHARTER_FILE="$2"; shift 2 ;;
        --spec)             CHARTER_FILE="$2"; shift 2 ;;  # backward compat
        --teammates)        TEAMMATE_COUNT="$2"; shift 2 ;;
        --name)             TEAM_NAME_OVERRIDE="$2"; shift 2 ;;
        --lead-cli)         LEAD_CLI_NAME="$2"; shift 2 ;;
        --teammate-cli)     TEAMMATE_CLI_NAME="$2"; shift 2 ;;
        -*)                 echo "Unknown option: $1" >&2; exit 1 ;;
        *)                  PROJECT_PATH="$1"; shift ;;
    esac
done

if [ -z "$PROJECT_PATH" ]; then
    echo "Error: project path required" >&2
    usage
    exit 1
fi

PROJECT_PATH="$(cd "$PROJECT_PATH" && pwd)"

if ! git -C "$PROJECT_PATH" rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: $PROJECT_PATH is not a git repository" >&2
    exit 1
fi

TEAM_NAME="${TEAM_NAME_OVERRIDE:-$(basename "$PROJECT_PATH")}"
SESSION="torc-$TEAM_NAME"

if team_exists "$TEAM_NAME"; then
    echo "Error: team '$TEAM_NAME' already exists" >&2
    exit 1
fi

# ── Get CLI commands ───────────────────────────────────────────────────────────

LEAD_CLI=$(get_cli_start_command "$LEAD_CLI_NAME")
TEAMMATE_CLI=$(get_cli_start_command "$TEAMMATE_CLI_NAME")

echo "Deploying self-organizing team: $TEAM_NAME"
echo "  Project:     $PROJECT_PATH"
echo "  Session:     $SESSION"
echo "  Lead:        $LEAD_CLI_NAME ($LEAD_CLI)"
echo "  Teammates:   $TEAMMATE_COUNT x $TEAMMATE_CLI_NAME"
[ -n "$CHARTER_FILE" ] && echo "  Charter:     $CHARTER_FILE"
echo ""

# ── Phase 1: Create team state and empty task list ─────────────────────────────

echo "=== Phase 1: Initialize team ==="

ensure_state_dirs
ensure_tasks_dir

CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
TASKS_FILE=$(tasks_file "$TEAM_NAME")

# Copy charter to project directory so all agents can read it
CHARTER_CONTENT=""
if [ -n "$CHARTER_FILE" ] && [ -f "$CHARTER_FILE" ]; then
    # Only copy if charter is not already in project root
    if [ "$CHARTER_FILE" != "$PROJECT_PATH/CHARTER.md" ]; then
        cp "$CHARTER_FILE" "$PROJECT_PATH/CHARTER.md"
        echo "  ✓ Charter copied to $PROJECT_PATH/CHARTER.md"
    else
        echo "  ✓ Charter already at $PROJECT_PATH/CHARTER.md"
    fi
    CHARTER_CONTENT=$(cat "$CHARTER_FILE" | sed 's/"/\\"/g')
fi

# Create task list with charter (Lead will populate tasks)
if [ -n "$CHARTER_CONTENT" ]; then
    INIT_TASKS=$(python3 -c "
import json
print(json.dumps({
    'team': '$TEAM_NAME',
    'version': 1,
    'charter': '''$CHARTER_CONTENT''',
    'tasks': [],
    'proposals': []
}, indent=2))
")
else
    INIT_TASKS=$(python3 -c "
import json
print(json.dumps({
    'team': '$TEAM_NAME',
    'version': 1,
    'tasks': [],
    'proposals': []
}, indent=2))
")
fi
echo "$INIT_TASKS" > "$TASKS_FILE"

# Create team state
STATE_JSON=$(python3 -c "
import json
print(json.dumps({
    'team_name': '$TEAM_NAME',
    'project_path': '$PROJECT_PATH',
    'session': '$SESSION',
    'created_at': '$CREATED_AT',
    'architecture': 'self-organizing',
    'charter_file': '$PROJECT_PATH/CHARTER.md',
    'max_teammates': $TEAMMATE_COUNT,
    'teammate_cli': '$TEAMMATE_CLI_NAME',
    'agents': {}
}, indent=2))
")
write_team_state "$TEAM_NAME" "$STATE_JSON"

echo "  ✓ Team state created"

# ── Phase 2: Create tmux session and Lead ───────────────────────────────────────

echo ""
echo "=== Phase 2: Spawn Lead ($LEAD_CLI_NAME) ==="

# Create Lead worktree first
LEAD_WT=$(worktree_create "$PROJECT_PATH" "lead" 2>&1 | tail -1)
echo "  Lead worktree: $LEAD_WT"

# Create tmux session if not exists
if ! tmux_session_exists "$SESSION"; then
    tmux_create_session "$SESSION" "$LEAD_WT" "Lead"
    sleep 0.5
else
    # Session exists, create Lead window
    tmux_create_window "$SESSION" "Lead" "$LEAD_WT"
    sleep 0.5
fi

# Update state
python3 - "$TEAM_NAME" "$LEAD_WT" <<'PYEOF'
import json, sys, os
team_name, lead_wt = sys.argv[1:3]
state_file = os.path.expanduser(f"~/.tmux-orchestrator/state/teams/{team_name}.json")
with open(state_file) as f:
    data = json.load(f)
data['agents']['lead'] = {
    'window': 'Lead',
    'worktree': lead_wt,
    'cli': '$LEAD_CLI_NAME',
    'role': 'lead'
}
with open(state_file, 'w') as f:
    json.dump(data, f, indent=2)
PYEOF

# Start Lead agent
tmux send-keys -t "$SESSION:Lead" "cd '$LEAD_WT' && $LEAD_CLI" Enter
sleep 8   # wait for CLI to fully load before sending briefing

echo "  ✓ Lead started"

# ── Phase 3: Lead Briefing ────────────────────────────────────────────────────

echo ""
echo "=== Phase 3: Briefing Lead ==="

# Check for charter file
CHARTER_PATH="$PROJECT_PATH/CHARTER.md"
if [ -f "$CHARTER_PATH" ]; then
    CHARTER_NOTE="Charter is at: $CHARTER_PATH"
else
    CHARTER_NOTE="No charter provided. Read existing project files to understand the goal."
fi

LEAD_BRIEFING="=== LEAD BRIEFING ===
You are the Lead of team '$TEAM_NAME'.
Worktree: $LEAD_WT

=== CRITICAL: USE TORC COMMANDS ONLY ===
You MUST use torc commands to manage the team. DO NOT use Claude Task tool.

First, ensure torc is in PATH:
export PATH=\"/Users/kifuko/dev/Tmux-Orchestrator/bin:\$PATH\"
which torc  # Verify it works

$CHARTER_NOTE

=== STEP 1: READ CHARTER (MUST DO FIRST) ===
cat $CHARTER_PATH

=== STEP 2: GENERATE TASKS AUTONOMOUSLY ===
Based on the charter, create 6-10 concrete tasks using torc:

torc team propose $TEAM_NAME lead 'T1: Project Setup' 'Initialize Next.js with TypeScript, Tailwind'
torc team propose $TEAM_NAME lead 'T2: Design System' 'Create pastel color palette and global styles'
torc team propose $TEAM_NAME lead 'T3: Hero Section' 'Animated gradient, floating elements, typewriter'
torc team propose $TEAM_NAME lead 'T4: About Section' 'Profile hover effect, skill cards with progress'
torc team propose $TEAM_NAME lead 'T5: Projects' '3D tilt cards, hover effects, filter buttons'
torc team propose $TEAM_NAME lead 'T6: Contact' 'Animated form, confetti success, social links'
torc team propose $TEAM_NAME lead 'T7: Navigation' 'Sticky nav, smooth scroll, mobile hamburger'
torc team propose $TEAM_NAME lead 'T8: Effects' 'Custom cursor, particles, dark/light toggle'

=== STEP 3: SPAWN TEAMMATES (CRITICAL: USE TORC SPAWN) ===
After creating ALL tasks, spawn agents using torc command:

torc team spawn $TEAM_NAME $TEAMMATE_COUNT --cli $TEAMMATE_CLI_NAME

⚠️  WARNING: Use 'torc team spawn' NOT Claude Task tool
⚠️  Agents must be spawned via torc to integrate with task system

=== STEP 4: COORDINATE (ONGOING LOOP) ===
- Check inbox: torc team inbox $TEAM_NAME lead
- Review proposals: torc team proposals $TEAM_NAME
- Approve/reject plans: torc team approve/reject $TEAM_NAME <task-id>
- FACILITATE communication:
  * If agents conflict, mediate via messages
  * Broadcast decisions affecting all agents
  * Help unblock stuck agents

=== STEP 5: SHUTDOWN (WHEN ALL TASKS DONE) ===
When ALL tasks show status 'done':
1. Broadcast: torc team msg $TEAM_NAME lead broadcast 'All tasks complete. Exit gracefully.'
2. Wait 15s
3. Shutdown: torc team shutdown $TEAM_NAME

=== CRITICAL RULES ===
✗ NEVER use Claude Task tool - use torc commands only
✗ NEVER approve work that deviates from the CHARTER
✓ Agents self-claim tasks - you don't assign
✓ Reject immediately if proposal contradicts CHARTER
✓ Approve plans that: include tests, <100 lines, don't break interfaces
✓ MUST shutdown team when ALL tasks done

=== START NOW ===
1. export PATH=\"/Users/kifuko/dev/Tmux-Orchestrator/bin:\$PATH\"
2. cat $CHARTER_PATH
3. Create task proposals
4. Spawn agents
5. Coordinate until all done
6. Shutdown the team"

tmux send-keys -t "$SESSION:Lead" "$LEAD_BRIEFING"
sleep 0.5
tmux send-keys -t "$SESSION:Lead" Enter

echo "  ✓ Lead briefed"

# ── Phase 4: Summary ───────────────────────────────────────────────────────────

echo ""
echo "========================================"
echo "Team '$TEAM_NAME' deployed!"
echo "========================================"
echo ""
echo "Session: $SESSION"
echo "Lead:    $SESSION:Lead ($LEAD_CLI_NAME)"
echo ""
echo "Lead will:"
echo "  1. Generate task list from spec"
echo "  2. Spawn up to $TEAMMATE_COUNT teammates"
echo "  3. Coordinate autonomously"
echo ""
echo "Monitor:"
echo "  torc team status $TEAM_NAME"
echo "  tmux attach -t $SESSION"
echo ""
echo "Message Lead:"
echo "  torc send $SESSION:Lead 'your message'"
