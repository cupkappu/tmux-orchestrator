#!/bin/bash
# torc-team-init - Create a self-organizing agent team with an empty task list
# Usage: torc team init <project-path> [--name <team-name>]
#
# Creates team state + empty task template for manual editing.
# For AI-generated task lists, use: torc team deploy (Lead generates tasks)

set -euo pipefail
TORC_BIN="$(cd "$(dirname "$0")" && pwd)"
source "$TORC_BIN/../lib/config.sh"
source "$TORC_BIN/../lib/state.sh"
source "$TORC_BIN/../lib/tasks.sh"

usage() {
    cat <<'EOF'
Usage: torc team init <project-path> [options]

Options:
  --name <name>   Override team name (default: project directory name)

Examples:
  torc team init ~/projects/my-app
  torc team init ~/projects/my-app --name my-team

For AI-generated task lists, use: torc team deploy
EOF
}

PROJECT_PATH=""
TEAM_NAME_OVERRIDE=""

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)   usage; exit 0 ;;
        --name)      TEAM_NAME_OVERRIDE="$2"; shift 2 ;;
        -*)          echo "Unknown option: $1" >&2; exit 1 ;;
        *)           PROJECT_PATH="$1"; shift ;;
    esac
done

if [ -z "$PROJECT_PATH" ]; then
    echo "Error: project path required" >&2
    usage
    exit 1
fi

PROJECT_PATH="$(cd "$PROJECT_PATH" && pwd)"

if ! git -C "$PROJECT_PATH" rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: $PROJECT_PATH is not a git repository" >&2
    exit 1
fi

TEAM_NAME="${TEAM_NAME_OVERRIDE:-$(basename "$PROJECT_PATH")}"
SESSION="torc-$TEAM_NAME"

if team_exists "$TEAM_NAME"; then
    echo "Error: team '$TEAM_NAME' already exists." >&2
    echo "  Run 'torc teardown $TEAM_NAME' to remove it first." >&2
    exit 1
fi

ensure_state_dirs
ensure_tasks_dir

CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

STATE_JSON=$(python3 -c "
import json
print(json.dumps({
    'team_name':    '$TEAM_NAME',
    'project_path': '$PROJECT_PATH',
    'session':      '$SESSION',
    'created_at':   '$CREATED_AT',
    'architecture': 'self-organizing',
    'agents':       {}
}, indent=2))
")
write_team_state "$TEAM_NAME" "$STATE_JSON"

TASKS_FILE="$(tasks_file "$TEAM_NAME")"

TASKS_JSON=$(python3 -c "
import json
print(json.dumps({
    'team': '$TEAM_NAME',
    'version': 1,
    'tasks': [
        {
            'id': 'T-001',
            'title': 'Example task',
            'description': 'Describe what to do and which files to touch.',
            'blocked_by': [],
            'require_plan': False,
            'status': 'pending',
            'owner': None,
            'plan': None,
            'plan_status': None,
            'plan_feedback': None,
            'created_at': '$CREATED_AT',
            'claimed_at': None,
            'plan_submitted_at': None,
            'plan_decided_at': None,
            'started_at': None,
            'done_at': None,
            'result': None
        }
    ]
}, indent=2))
")

echo "$TASKS_JSON" > "$TASKS_FILE"

TASK_COUNT=$(python3 -c "import json; d=json.load(open('$TASKS_FILE')); print(len(d['tasks']))")

echo "Team '$TEAM_NAME' initialised"
echo "  Project:   $PROJECT_PATH"
echo "  Tasks:     $TASKS_FILE ($TASK_COUNT tasks)"
echo ""
echo "Task list:"
tasks_list "$TEAM_NAME"
echo ""

echo "Edit $TASKS_FILE to define your tasks, then:"
echo ""
echo "  torc team spawn $TEAM_NAME <n>    # spawn N agents"
echo "  torc team status $TEAM_NAME       # monitor progress"
echo ""
echo "Or use 'torc team deploy' instead for AI-generated task lists."
