#!/bin/bash
# torc-team-spawn - Spawn N agent teammates for a team
# Usage: torc team spawn <team-name> <n> [--cli <cli-tool>]
#
# Creates worktree + tmux window per agent, starts CLI with briefing.
# Agents run autonomously: claim → plan → (wait approval) → work → done → claim next

set -euo pipefail
TORC_BIN="$(cd "$(dirname "$0")" && pwd)"
source "$TORC_BIN/../lib/config.sh"
source "$TORC_BIN/../lib/state.sh"
source "$TORC_BIN/../lib/tasks.sh"
source "$TORC_BIN/../lib/worktree.sh"
source "$TORC_BIN/../lib/tmux.sh"

usage() {
    cat <<'EOF'
Usage: torc team spawn <team-name> <n> [options]

Arguments:
  team-name    Team to spawn agents for
  n            Number of agents to spawn

Options:
  --cli <tool> CLI tool to use (kimi, opencode, claude). Default: kimi

Examples:
  torc team spawn my-app 3
  torc team spawn my-app 2 --cli opencode
EOF
}

TEAM_NAME=""
AGENT_COUNT=""
CLI_TOOL=$(get_selforg_default_cli "agent")

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)   usage; exit 0 ;;
        --cli)       CLI_TOOL="$2"; shift 2 ;;
        -*)          echo "Unknown option: $1" >&2; exit 1 ;;
        *)
            if [ -z "$TEAM_NAME" ]; then
                TEAM_NAME="$1"
            elif [ -z "$AGENT_COUNT" ]; then
                AGENT_COUNT="$1"
            else
                echo "Error: too many arguments" >&2
                exit 1
            fi
            shift
            ;;
    esac
done

if [ -z "$TEAM_NAME" ] || [ -z "$AGENT_COUNT" ]; then
    echo "Error: team name and agent count required" >&2
    usage
    exit 1
fi

if ! [[ "$AGENT_COUNT" =~ ^[0-9]+$ ]] || [ "$AGENT_COUNT" -lt 1 ]; then
    echo "Error: agent count must be a positive integer" >&2
    exit 1
fi

if ! team_exists "$TEAM_NAME"; then
    echo "Error: team '$TEAM_NAME' not found" >&2
    echo "  Run 'torc team init <project>' first." >&2
    exit 1
fi

PROJECT_PATH=$(team_field "$TEAM_NAME" "project_path")
SESSION=$(team_field "$TEAM_NAME" "session")
TASKS_FILE=$(tasks_file "$TEAM_NAME")

if [ ! -f "$TASKS_FILE" ]; then
    echo "Error: no task list found for team '$TEAM_NAME'" >&2
    echo "  Run 'torc team init' first." >&2
    exit 1
fi

CLI_CMD=$(get_cli_start_command "$CLI_TOOL")

echo "Spawning $AGENT_COUNT agent(s) for team '$TEAM_NAME'"
echo "  Project: $PROJECT_PATH"
echo "  Session: $SESSION"
echo "  CLI: $CLI_TOOL"
echo ""

if ! tmux_session_exists "$SESSION"; then
    echo "Creating tmux session '$SESSION'..."
    tmux_create_session "$SESSION" "$PROJECT_PATH" "Team"
    sleep 0.5
    echo "  ✓ Session created"
    echo ""
fi

SPAWNED=()

for i in $(seq 1 "$AGENT_COUNT"); do
    AGENT_ID="agent-$i"
    WINDOW_NAME="Agent-$i"
    
    if tmux_window_exists "$SESSION:$WINDOW_NAME" 2>/dev/null; then
        echo "  ⚠ Agent-$i already exists, skipping"
        continue
    fi
    
    echo "  Creating Agent-$i..."
    
    WT_PATH=$(worktree_create "$PROJECT_PATH" "$AGENT_ID" 2>&1 | tail -1) || {
        echo "    ✗ Failed to create worktree: $WT_PATH" >&2
        continue
    }
    echo "    ✓ Worktree: $WT_PATH"
    
    tmux_create_window "$SESSION" "$WINDOW_NAME" "$WT_PATH"
    sleep 0.5
    echo "    ✓ Window: $SESSION:$WINDOW_NAME"
    
    python3 - "$TEAM_NAME" "$AGENT_ID" "$WINDOW_NAME" "$WT_PATH" "$CLI_TOOL" <<'EOF'
import json, sys, os
team_name, agent_id, window, worktree, cli = sys.argv[1:6]

state_file = f"{os.path.expanduser('~')}/.tmux-orchestrator/state/teams/{team_name}.json"
with open(state_file) as f:
    data = json.load(f)

if 'agents' not in data:
    data['agents'] = {}

data['agents'][agent_id] = {
    'window': window,
    'worktree': worktree,
    'cli': cli,
    'status': 'spawning'
}

with open(state_file, 'w') as f:
    json.dump(data, f, indent=2)
EOF
    
    TARGET="$SESSION:$WINDOW_NAME"

    # Get appropriate startup wait time for this CLI
    STARTUP_WAIT=$(get_cli_startup_time "$CLI_TOOL")

    echo "    Starting $CLI_CMD..."
    echo "    (waiting ${STARTUP_WAIT}s for CLI to load...)"
    tmux send-keys -t "$TARGET" "cd '$WT_PATH' && $CLI_CMD" Enter
    sleep "$STARTUP_WAIT"   # wait for CLI to fully load before sending briefing

    BRIEFING="=== AGENT BRIEFING ===
You are Agent-$i in team '$TEAM_NAME'.
Worktree: $WT_PATH

=== YOUR MISSION ===
Work autonomously: claim tasks, submit plans, implement, repeat until all work is done.

=== SETUP ===
export PATH=\"/Users/kifuko/dev/Tmux-Orchestrator/bin:\$PATH\"
cd $WT_PATH

=== INITIALIZATION (DO FIRST) ===

STEP 0: Send ready signal to Lead (CRITICAL)
You MUST notify Lead that you are ready BEFORE claiming tasks:

torc team msg $TEAM_NAME $WINDOW_NAME lead 'Agent-$i READY. Worktree: $WT_PATH'

Wait 5 seconds, then proceed to work loop.

=== WORK LOOP (REPEAT UNTIL ALL TASKS DONE) ===

STEP 1: Check inbox for notifications
torc team inbox $TEAM_NAME $WINDOW_NAME

STEP 2: Claim next available task
torc team claim $TEAM_NAME $WINDOW_NAME

If claim FAILS (exit 1):
  - Try 2 more times with 30s delay
  - If still failing → ALL TASKS DONE → type 'exit' and STOP

STEP 3: Check if plan is required
torc team status $TEAM_NAME --task <task-id>

If require_plan=true:
  - Write specific plan (list files, approach, tests)
  - torc team plan-submit $TEAM_NAME <task-id> 'Plan: 1. Create X, 2. Add Y, 3. Test Z'
  - Wait for approval (check inbox every 30s)
  - If rejected: revise plan and resubmit
  - If approved: proceed to Step 4

STEP 4: Implement the task
- Work in $WT_PATH
- Write code according to CHARTER (check $PROJECT_PATH/CHARTER.md if unclear)
- Commit every 10-15 minutes: git add . && git commit -m '<task-id>: description'
- Run tests if available

STEP 5: Mark task done
torc team done $TEAM_NAME <task-id> 'Completed: specific result'

STEP 6: Go back to STEP 1

=== COLLABORATION WITH TEAMMATES (IMPORTANT) ===

You are NOT working alone. Coordinate with other agents actively.

WHEN TO MESSAGE OTHER AGENTS:

1. BEFORE starting work on interfaces:
   If your task touches shared components (Button, Card, Nav), message the owner:
   torc team msg $TEAM_NAME $WINDOW_NAME Agent-1 'Hi, I need to use your Button component. What props does it accept?'

2. WHEN your task is blocked:
   torc team msg $TEAM_NAME $WINDOW_NAME <owner> 'My task T-003 needs T-001 to finish first. ETA on your task?'

3. WHEN you finish a shared component:
   torc team msg $TEAM_NAME $WINDOW_NAME broadcast 'Design System complete. Components available: Button, Card, Nav. See src/components/'

4. TO DISCUSS integration:
   torc team msg $TEAM_NAME $WINDOW_NAME Agent-2 'For Contact form, I need to POST to /api/contact. Is API ready?'

COMMUNICATION COMMANDS:
- Message Lead:     torc team msg $TEAM_NAME $WINDOW_NAME lead 'need help with X'
- Message Agent-1:  torc team msg $TEAM_NAME $WINDOW_NAME Agent-1 'question about Y'
- Message Agent-2:  torc team msg $TEAM_NAME $WINDOW_NAME Agent-2 'update on Z'
- Broadcast all:    torc team msg $TEAM_NAME $WINDOW_NAME broadcast 'announcement'

CHECK MESSAGES FREQUENTLY:
After each implementation step, check inbox:
torc team inbox $TEAM_NAME $WINDOW_NAME

Reply promptly to unblock teammates.

=== AUTO-EXIT RULES ===
YOU MUST EXIT (type 'exit') when:
1. torc team claim fails 3 times in a row (no more claimable tasks)
2. Lead sends shutdown message
3. All tasks are marked 'done' in torc team status

DO NOT continue running when there's no work.

=== START NOW ===
torc team inbox $TEAM_NAME $WINDOW_NAME
torc team claim $TEAM_NAME $WINDOW_NAME"
    
    "$TORC_BIN/torc-send" "$TARGET" "$BRIEFING"
    
    echo "    ✓ Agent started with briefing"
    echo ""
    
    SPAWNED+=("$AGENT_ID")
done

echo "=== Spawn Complete ==="
echo "Spawned ${#SPAWNED[@]} agent(s):"
for agent in "${SPAWNED[@]}"; do
    echo "  - $agent"
done
echo ""
echo "Monitor progress:"
echo "  torc team status $TEAM_NAME"
echo "  tmux attach -t $SESSION"
echo ""
echo "Agents will self-claim tasks and work autonomously."
echo "Approve plans with: torc team approve $TEAM_NAME <task-id>"
